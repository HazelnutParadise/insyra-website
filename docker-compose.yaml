version: "3.8"

services:
  insyra-website:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: insyra-website
    ports:
      - "1234:8080"
    restart: always

  updater:
    image: alpine/git
    container_name: insyra-updater
    environment:
      - REPO_URL=https://github.com/HazelnutParadise/insyra-website.git
    volumes:
      - .:/app
    entrypoint: >
      /bin/sh -c "
      # 延遲 60 秒，確保 insyra-website 服務已啟動
      sleep 60;
      while true; do
        # 如果 .git 資料夾不存在，克隆儲存庫；否則，只進行更新拉取
        if [ ! -d '/app/.git' ]; then
          git clone $REPO_URL /app;
        else
          git -C /app pull;
          docker restart insyra-website;  # 重啟應用容器以應用最新更新
        fi
        sleep 3600;
      done
      "
